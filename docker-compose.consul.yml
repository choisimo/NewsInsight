version: "3.9"

# Unified stack with Consul KV and all present services
services:
  consul:
    image: hashicorp/consul:1.18
    command: ["agent", "-dev", "-client", "0.0.0.0", "-ui"]
    ports:
      - "8500:8500"  # Consul UI/API
    environment:
      # Optional: advertise container hostname in logs
      - CONSUL_BIND_INTERFACE=eth0
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8500/v1/status/leader"]
      interval: 5s
      timeout: 3s
      retries: 20

  # Init container to seed Consul KV with configuration
  consul-seed:
    image: alpine:3.18
    depends_on:
      consul:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts:ro
      - ./configs:/configs:ro
    environment:
      - CONSUL_HTTP_ADDR=http://consul:8500
      - CONSUL_HTTP_TOKEN=${CONSUL_HTTP_TOKEN:-}
    command: >
      sh -c "
        apk add --no-cache curl bash jq &&
        /scripts/consul_seed.sh ${ENVIRONMENT:-development}
      "
    restart: "no"

  api-gateway:
    build:
      context: ./code/BACKEND-API-GATEWAY
    image: pension/api-gateway:local
    depends_on:
      consul:
        condition: service_healthy
      consul-seed:
        condition: service_completed_successfully
      analysis-service:
        condition: service_started
      collector-service:
        condition: service_started
    environment:
      # Consul access for config loading in the app
      - CONSUL_HTTP_ADDR=${CONSUL_HTTP_ADDR:-http://consul:8500}
      - CONSUL_HTTP_TOKEN=${CONSUL_HTTP_TOKEN:-}
      # Backward-compat envs (until full KV migration completes)
      - PORT=${API_GATEWAY_PORT:-8080}
      - DEBUG=${API_GATEWAY_DEBUG:-true}
      - ANALYSIS_SERVICE_URL=${ANALYSIS_SERVICE_URL:-http://analysis-service:8001}
      - COLLECTOR_SERVICE_URL=${COLLECTOR_SERVICE_URL:-http://collector-service:8002}
    ports:
      - "8080:8000"

  analysis-service:
    build:
      context: ./code/BACKEND-ANALYSIS-SERVICE
    image: pension/analysis-service:local
    depends_on:
      consul:
        condition: service_healthy
      consul-seed:
        condition: service_completed_successfully
    environment:
      - CONSUL_HTTP_ADDR=${CONSUL_HTTP_ADDR:-http://consul:8500}
      - CONSUL_HTTP_TOKEN=${CONSUL_HTTP_TOKEN:-}
      # Backward-compat envs
      - DATABASE_URL=${ANALYSIS_DATABASE_URL:-}
      - REDIS_URL=${ANALYSIS_REDIS_URL:-}
      - API_GATEWAY_URL=${API_GATEWAY_URL:-http://api-gateway:8080}
      - COLLECTOR_SERVICE_URL=${COLLECTOR_SERVICE_URL:-http://collector-service:8002}
    ports:
      - "8001:8001"

  collector-service:
    build:
      context: ./code/BACKEND-COLLECTOR-SERVICE
    image: pension/collector-service:local
    depends_on:
      consul:
        condition: service_healthy
      consul-seed:
        condition: service_completed_successfully
    environment:
      - CONSUL_HTTP_ADDR=${CONSUL_HTTP_ADDR:-http://consul:8500}
      - CONSUL_HTTP_TOKEN=${CONSUL_HTTP_TOKEN:-}
      # Backward-compat envs
      - PORT=${COLLECTOR_PORT:-8002}
      - DATABASE_URL=${COLLECTOR_DATABASE_URL:-postgresql://postgres:password@postgres:5432/pension_sentiment}
      - REDIS_URL=${COLLECTOR_REDIS_URL:-redis://redis:6379/0}
      - ANALYSIS_SERVICE_URL=${ANALYSIS_SERVICE_URL:-http://analysis-service:8001}
    ports:
      - "8002:8002"

  web-crawler:
    build:
      context: ./code/BACKEND-WEB-CRAWLER
    image: pension/web-crawler:local
    depends_on:
      consul:
        condition: service_healthy
      consul-seed:
        condition: service_completed_successfully
    environment:
      - CONSUL_HTTP_ADDR=${CONSUL_HTTP_ADDR:-http://consul:8500}
      - CONSUL_HTTP_TOKEN=${CONSUL_HTTP_TOKEN:-}
    ports:
      - "5000:5000"

networks:
  default:
    name: pension-net
