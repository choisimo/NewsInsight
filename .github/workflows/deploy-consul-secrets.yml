name: Deploy Consul Secrets to Remote Server

on:
  push:
    branches: [ main ]
    paths:
      - 'etc/configs/**'
      - 'etc/scripts/consul_seed.sh'
      - '.github/workflows/deploy-consul-secrets.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      config_mode:
        description: 'Configuration source'
        required: true
        default: 'both'
        type: choice
        options:
          - env
          - json
          - both
      skip_validation:
        description: 'Skip configuration validation'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
  CONFIG_MODE: ${{ github.event.inputs.config_mode || 'both' }}

jobs:
  # Validate configuration before deployment
  validate:
    name: Validate Configuration
    if: ${{ github.event.inputs.skip_validation != 'true' }}
    uses: ./.github/workflows/validate-config.yml

  deploy-secrets:
    runs-on: ubuntu-latest
    needs: [validate]
    if: |
      always() &&
      (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create environment config file
        run: |
          mkdir -p etc/configs
          cat > etc/configs/${{ env.DEPLOY_ENVIRONMENT }}.env << 'EOF'
          # =============================================================================
          # API Gateway Service Configuration
          # =============================================================================
          API_GATEWAY_PORT=${{ secrets.API_GATEWAY_PORT || '8000' }}
          API_GATEWAY_DEBUG=${{ secrets.API_GATEWAY_DEBUG || 'false' }}
          API_GATEWAY_JWT_SECRET_KEY=${{ secrets.API_GATEWAY_JWT_SECRET_KEY }}
          API_GATEWAY_CORS_ORIGINS=${{ secrets.API_GATEWAY_CORS_ORIGINS || '*' }}
          API_GATEWAY_RATE_LIMIT_REQUESTS=${{ secrets.API_GATEWAY_RATE_LIMIT_REQUESTS || '100' }}
          API_GATEWAY_RATE_LIMIT_WINDOW=${{ secrets.API_GATEWAY_RATE_LIMIT_WINDOW || '60' }}
          
          # =============================================================================
          # Collector Service Configuration
          # =============================================================================
          COLLECTOR_SERVICE_PORT=${{ secrets.COLLECTOR_PORT || '8081' }}
          COLLECTOR_SERVICE_DATABASE_URL=${{ secrets.COLLECTOR_SERVICE_DATABASE_URL }}
          COLLECTOR_SERVICE_REDIS_URL=${{ secrets.COLLECTOR_SERVICE_REDIS_URL }}
          COLLECTOR_SERVICE_MONGODB_URI=${{ secrets.COLLECTOR_SERVICE_MONGODB_URI }}
          COLLECTOR_SERVICE_KAFKA_BOOTSTRAP_SERVERS=${{ secrets.COLLECTOR_SERVICE_KAFKA_BOOTSTRAP_SERVERS }}
          
          # Collector Service - Callback URLs (for internal services)
          COLLECTOR_SERVICE_CALLBACK_BASE_URL=${{ secrets.COLLECTOR_SERVICE_CALLBACK_BASE_URL || 'http://collector-service:8081' }}
          COLLECTOR_SERVICE_AIDOVE_BASE_URL=${{ secrets.COLLECTOR_SERVICE_AIDOVE_BASE_URL || 'https://workflow.nodove.com/webhook/aidove' }}
          
          # =============================================================================
          # DeepSearch Configuration (IntegratedCrawlerService)
          # =============================================================================
          # DeepSearch now uses internal services only (n8n webhook is DEPRECATED)
          COLLECTOR_SERVICE_DEEP_SEARCH_ENABLED=false
          COLLECTOR_DEEP_SEARCH_USE_INTEGRATED=true
          COLLECTOR_DEEP_SEARCH_FALLBACK_TO_WEBHOOK=false
          
          # =============================================================================
          # Analysis Service Configuration
          # =============================================================================
          ANALYSIS_SERVICE_PORT=${{ secrets.ANALYSIS_SERVICE_PORT || '8001' }}
          ANALYSIS_SERVICE_DATABASE_URL=${{ secrets.ANALYSIS_SERVICE_DATABASE_URL }}
          ANALYSIS_SERVICE_REDIS_URL=${{ secrets.ANALYSIS_SERVICE_REDIS_URL }}
          
          # =============================================================================
          # Web Crawler Configuration
          # =============================================================================
          WEB_CRAWLER_LOG_LEVEL=${{ secrets.WEB_CRAWLER_LOG_LEVEL || 'INFO' }}
          
          # =============================================================================
          # AI/LLM API Keys
          # =============================================================================
          COLLECTOR_SERVICE_PERPLEXITY_API_KEY=${{ secrets.PERPLEXITY_API_KEY }}
          COLLECTOR_SERVICE_PERPLEXITY_MODEL=${{ secrets.PERPLEXITY_MODEL || 'sonar' }}
          COLLECTOR_SERVICE_PERPLEXITY_BASE_URL=${{ secrets.PERPLEXITY_BASE_URL || 'https://api.perplexity.ai' }}
          COLLECTOR_SERVICE_OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          COLLECTOR_SERVICE_ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          EOF

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REMOTE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

      - name: Copy consul_seed.sh to remote server
        run: |
          scp -o StrictHostKeyChecking=no \
            etc/scripts/consul_seed.sh \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_DEPLOY_PATH }}/scripts/

      - name: Copy services.json to remote server
        if: ${{ env.CONFIG_MODE == 'json' || env.CONFIG_MODE == 'both' }}
        run: |
          scp -o StrictHostKeyChecking=no \
            etc/configs/services.json \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_DEPLOY_PATH }}/configs/

      - name: Copy environment config to remote server
        if: ${{ env.CONFIG_MODE == 'env' || env.CONFIG_MODE == 'both' }}
        run: |
          scp -o StrictHostKeyChecking=no \
            etc/configs/${{ env.DEPLOY_ENVIRONMENT }}.env \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_DEPLOY_PATH }}/configs/

      - name: Deploy secrets to Consul on remote server
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'ENDSSH'
          cd ${{ secrets.REMOTE_DEPLOY_PATH }}
          
          # Ensure scripts are executable
          chmod +x scripts/consul_seed.sh
          
          # Set Consul connection details
          export CONSUL_HTTP_ADDR="${{ secrets.CONSUL_HTTP_ADDR }}"
          export CONSUL_HTTP_TOKEN="${{ secrets.CONSUL_HTTP_TOKEN }}"
          
          # Run the seed script with the target environment and config mode
          ./scripts/consul_seed.sh ${{ env.DEPLOY_ENVIRONMENT }} --${{ env.CONFIG_MODE }}
          
          # Clean up sensitive config files after seeding
          rm -f configs/${{ env.DEPLOY_ENVIRONMENT }}.env
          
          echo "Consul secrets deployed successfully!"
          ENDSSH

      - name: Verify Consul keys (optional)
        if: ${{ secrets.CONSUL_HTTP_ADDR != '' }}
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'ENDSSH'
          
          CONSUL_ADDR="${{ secrets.CONSUL_HTTP_ADDR }}"
          
          echo "Verifying Consul keys..."
          
          # List keys for each service
          for service in api-gateway collector-service analysis-service web-crawler; do
            echo "=== Service: $service ==="
            curl -sf "${CONSUL_ADDR}/v1/kv/config/${service}/?keys" 2>/dev/null | jq -r '.[]' 2>/dev/null || echo "No keys found or error"
          done
          ENDSSH

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/id_rsa

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: deploy-secrets
    if: failure()
    steps:
      - name: Notify deployment failure
        run: |
          echo "::error::Consul secrets deployment failed!"
          echo "Please check the logs and ensure all required secrets are configured."
