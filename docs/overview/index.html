<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved System Architecture (v2.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
    </script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        .mermaid { display: flex; justify-content: center; margin-bottom: 2rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-indigo-600">System Architecture Overview</h1>
                <p class="text-sm text-gray-500 mt-1">v2.0: Event-Driven Decoupled Architecture</p>
            </div>
            <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-medium">v2.0 Enhanced</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="bg-white rounded-xl shadow-lg p-6 mb-10 border border-gray-100">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 border-l-4 border-indigo-500 pl-3">Architecture Diagram (Separation of Concerns)</h2>
            <div class="overflow-x-auto">
                <div class="mermaid">
                    flowchart LR
                        Client -->|HTTPS| Gateway["API Gateway\n(Spring Cloud Gateway)"]
                        Gateway -->|Route| ApiServer["API Server\n(User Request Handling)"]
                        
                        %% ë°ì´í„° ì €ì¥ì†Œ
                        ApiServer -->|JPA| PostgreSQL[(PostgreSQL\nUser/Meta)]
                        Gateway --> Redis[(Redis\nRate Limiter)]
                        
                        %% ë¹„ë™ê¸° ì‘ì—… ì‹œì‘
                        ApiServer -.->|Publish Command| Kafka[(Kafka\nEvent Broker)]

                        %% ë°±ê·¸ë¼ìš´ë“œ ì›Œì»¤ ê·¸ë£¹
                        subgraph Background_Workers [Async Worker Layer]
                            direction TB
                            Kafka -->|Consume Command| Crawler["Crawler Worker\n(Scraping Service)"]
                            Crawler -->|Async Fetch| ExternalSources["External Sources\n(News/RSS/Web)"]
                            
                            Crawler -->|Produce Raw Data| Kafka
                            Kafka -->|Consume Data| AIAgent["AI Agent Server\n(Go, AI Analysis)"]
                            AIAgent -->|Produce Result| Kafka
                            
                            Kafka -->|Consume Result| ResultConsumer["Result Consumer\n(Persistence Service)"]
                            ResultConsumer -->|Store| Mongo[(MongoDB\nAnalysis Result)]
                        end
                        
                        %% ìŠ¤íƒ€ì¼ë§
                        style Gateway fill:#e0e7ff,stroke:#4338ca,stroke-width:2px
                        style ApiServer fill:#dbeafe,stroke:#1e40af,stroke-width:2px
                        style Crawler fill:#fef3c7,stroke:#d97706,stroke-width:2px
                        style AIAgent fill:#f3e8ff,stroke:#7e22ce,stroke-width:2px
                        style ResultConsumer fill:#d1fae5,stroke:#059669,stroke-width:2px
                        style Kafka fill:#ffedd5,stroke:#c2410c,stroke-width:2px
                </div>
            </div>
            <p class="mt-4 text-xs text-gray-500">
                Kafka í† í”½:
                <code>newsinsight.crawl.commands</code> (í¬ë¡¤ ëª…ë ¹, <code>CrawlCommandMessage</code>),
                <code>newsinsight.crawl.results</code> (í¬ë¡¤ ê²°ê³¼, <code>CrawlResultMessage</code>),
                <code>newsinsight.ai.requests</code> / <code>newsinsight.ai.responses</code> (AI ë¶„ì„ ìš”ì²­/ì‘ë‹µ).
            </p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-10 border border-gray-100">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 border-l-4 border-green-500 pl-3">Async Timelines (Crawl &amp; AI)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Crawling Pipeline</h3>
                    <div class="mermaid text-xs">
sequenceDiagram
    participant Client
    participant Gateway
    participant Collector as Collector Service
    participant Kafka as Kafka
    participant Crawler as Crawler Worker
    participant ResultConsumer as Crawl Result Consumer
    participant DB as PostgreSQL

    Client->>Gateway: POST /api/v1/collections/start
    Gateway->>Collector: /api/v1/collections/start
    Collector->>Collector: CollectionJob ìƒì„± (PENDING)
    Collector->>Kafka: Produce CrawlCommandMessage
    Kafka-->>Crawler: Consume CrawlCommandMessage
    Crawler->>External: RSS/Web Fetch
    Crawler->>Kafka: Produce CrawlResultMessage
    Kafka-->>ResultConsumer: Consume CrawlResultMessage
    ResultConsumer->>DB: save CollectedData
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">AI Analysis Pipeline</h3>
                    <div class="mermaid text-xs">
sequenceDiagram
    participant Client
    participant Gateway
    participant Collector as Collector Service
    participant Kafka as Kafka
    participant AIAgent as AI Agent Server
    participant LLM as OpenCode API
    participant Mongo as MongoDB

    Client->>Gateway: GET /api/v1/analysis?query=...
    Gateway->>Collector: /api/v1/analysis
    Collector->>Collector: PostgreSQLì—ì„œ ì§‘ê³„ (ë™ê¸°)
    Collector->>Kafka: Produce AiRequestMessage
    Collector-->>Client: AnalysisResponseDto ë°˜í™˜ (AI ì™„ë£Œ ëŒ€ê¸° ì—†ìŒ)
    Kafka-->>AIAgent: Consume AiRequestMessage
    AIAgent->>LLM: ì„¸ì…˜/ë©”ì‹œì§€ API í˜¸ì¶œ
    LLM-->>AIAgent: AI ì‘ë‹µ í…ìŠ¤íŠ¸
    AIAgent->>Kafka: Produce AiResponseMessage
    Kafka-->>Collector: AiResultConsumer consumes
    Collector->>Mongo: Save AiResponseDocument
                    </div>
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-gray-800 mb-6">Key Improvements Breakdown</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <div class="bg-white rounded-lg shadow p-5 border-t-4 border-blue-600 hover:shadow-md transition-shadow">
                <div class="flex items-center mb-3">
                    <div class="p-2 bg-blue-100 rounded-lg mr-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path></svg>
                    </div>
                    <h3 class="font-bold text-lg">API Server (Pure)</h3>
                </div>
                <p class="text-gray-600 text-sm mb-3"><strong>ì—­í•  ì¶•ì†Œ:</strong> ë¬´ê±°ìš´ ì‘ì—…(í¬ë¡¤ë§)ì„ ì œê±°í•˜ê³ , ì‚¬ìš©ì ìš”ì²­ ì‘ë‹µê³¼ ë©”íƒ€ë°ì´í„° ê´€ë¦¬ì—ë§Œ ì§‘ì¤‘í•©ë‹ˆë‹¤.</p>
                <ul class="text-sm text-gray-500 list-disc list-inside space-y-1">
                    <li><strong>Stable:</strong> í¬ë¡¤ë§ ì§€ì—°ì´ API ì†ë„ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ</li>
                    <li><strong>Command Publisher:</strong> ì‘ì—… ì§€ì‹œ(Event)ë§Œ Kafkaë¡œ ë°œí–‰</li>
                </ul>
            </div>

            <div class="bg-white rounded-lg shadow p-5 border-t-4 border-yellow-500 hover:shadow-md transition-shadow">
                <div class="flex items-center mb-3">
                    <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                    </div>
                    <h3 class="font-bold text-lg">Crawler Worker</h3>
                </div>
                <p class="text-gray-600 text-sm mb-3"><strong>ë…ë¦½ì  ìˆ˜ì§‘:</strong> ì™¸ë¶€ ì†ŒìŠ¤ì™€ì˜ í†µì‹ ë§Œ ì „ë‹´í•˜ëŠ” ë³„ë„ì˜ ì›Œì»¤ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>
                <ul class="text-sm text-gray-500 list-disc list-inside space-y-1">
                    <li><strong>Isolation:</strong> ì™¸ë¶€ ì‚¬ì´íŠ¸ ì¥ì•  ì‹œì—ë„ ê²©ë¦¬ë˜ì–´ ì•ˆì „</li>
                    <li><strong>Scalable:</strong> ìˆ˜ì§‘ ëŒ€ìƒì´ ëŠ˜ì–´ë‚˜ë©´ ì´ ì„œë¹„ìŠ¤ë§Œ ì¦ì„¤</li>
                </ul>
            </div>

            <div class="bg-white rounded-lg shadow p-5 border-t-4 border-green-500 hover:shadow-md transition-shadow">
                <div class="flex items-center mb-3">
                    <div class="p-2 bg-green-100 rounded-lg mr-3">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    </div>
                    <h3 class="font-bold text-lg">Result Consumer</h3>
                </div>
                <p class="text-gray-600 text-sm mb-3">ìµœì¢… ë¶„ì„ ê²°ê³¼ë¥¼ DBì— ì €ì¥í•˜ëŠ” ì—­í• ë§Œ ìˆ˜í–‰í•˜ì—¬ ì“°ê¸° ë³‘ëª©ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <ul class="text-sm text-gray-500 list-disc list-inside space-y-1">
                    <li><strong>Reliability:</strong> DB ë¶€í•˜ì— ë”°ë¼ ì†Œë¹„ ì†ë„ ì¡°ì ˆ (Throttling)</li>
                    <li><strong>Finalizer:</strong> ë°ì´í„° ì •í•©ì„± ìµœì¢… í™•ì¸ ë° ì €ì¥</li>
                </ul>
            </div>

        </div>
        
        <div class="mt-10 bg-indigo-50 rounded-xl p-6 border border-indigo-100">
            <h3 class="text-lg font-bold text-indigo-900 mb-2">ğŸ’¡ Why is this better?</h3>
            <p class="text-indigo-700 text-sm leading-relaxed">
                ì´ì „ ë²„ì „(v1.0)ì˜ <strong>Collector Service</strong>ê°€ ê°€ì§€ê³  ìˆë˜ "God Class(ê³¼ë„í•œ ì±…ì„)" ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. 
                ì´ì œ ì‚¬ìš©ìê°€ ì ‘ì†í•˜ëŠ” <strong>API Server</strong>ëŠ” ì™¸ë¶€ ë‰´ìŠ¤ ì‚¬ì´íŠ¸ì˜ ì‘ë‹µ ì†ë„ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì¾Œì í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤. 
                ë°ì´í„° ìˆ˜ì§‘ê³¼ ë¶„ì„ì€ <strong>Kafka</strong>ë¥¼ ì™„ì¶©ì œ(Buffer)ë¡œ ì‚¼ì•„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
            </p>
        </div>

    </main>
    
    <footer class="bg-white border-t border-gray-200 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm">
        </div>
    </footer>

</body>
</html>