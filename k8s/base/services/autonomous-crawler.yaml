# Autonomous Crawler Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: autonomous-crawler
  namespace: newsinsight
  labels:
    app: autonomous-crawler
    app.kubernetes.io/name: autonomous-crawler
    app.kubernetes.io/component: crawler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: autonomous-crawler
  template:
    metadata:
      labels:
        app: autonomous-crawler
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
    spec:
      serviceAccountName: newsinsight-sa
      containers:
        - name: autonomous-crawler
          image: autonomous-crawler:latest
          ports:
            - containerPort: 9090
              name: metrics
          env:
            # Consul
            - name: CONSUL_HOST
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: CONSUL_HOST
            - name: CONSUL_PORT
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: CONSUL_PORT
            - name: CONSUL_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: CONSUL_ENABLED
            - name: CONSUL_SERVICE_NAME
              value: "autonomous-crawler"
            # Kafka
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: KAFKA_BOOTSTRAP_SERVERS
            - name: KAFKA_CONSUMER_GROUP_ID
              value: "autonomous-crawler-group"
            - name: KAFKA_BROWSER_TASK_TOPIC
              value: "newsinsight.crawl.browser.tasks"
            - name: KAFKA_CRAWL_RESULT_TOPIC
              value: "newsinsight.crawl.results"
            # Browser
            - name: BROWSER_HEADLESS
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: BROWSER_HEADLESS
            - name: BROWSER_MAX_CONCURRENT_SESSIONS
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: BROWSER_MAX_CONCURRENT_SESSIONS
            - name: BROWSER_DEFAULT_TIMEOUT_SECONDS
              value: "300"
            # LLM
            - name: LLM_PROVIDER
              value: "openai"
            - name: LLM_OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: newsinsight-secrets
                  key: OPENAI_API_KEY
            - name: LLM_OPENAI_MODEL
              value: "gpt-4o"
            - name: LLM_ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: newsinsight-secrets
                  key: ANTHROPIC_API_KEY
            - name: LLM_ANTHROPIC_MODEL
              value: "claude-3-5-sonnet-20241022"
            # Search APIs
            - name: SEARCH_BRAVE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: newsinsight-secrets
                  key: BRAVE_API_KEY
                  optional: true
            - name: SEARCH_TAVILY_API_KEY
              valueFrom:
                secretKeyRef:
                  name: newsinsight-secrets
                  key: TAVILY_API_KEY
                  optional: true
            - name: SEARCH_PERPLEXITY_API_KEY
              valueFrom:
                secretKeyRef:
                  name: newsinsight-secrets
                  key: PERPLEXITY_API_KEY
            # Stealth & Metrics
            - name: STEALTH_ENABLED
              value: "true"
            - name: CAPTCHA_ENABLED
              value: "true"
            - name: METRICS_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: METRICS_ENABLED
            - name: METRICS_PORT
              value: "9090"
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: LOG_LEVEL
            - name: LOG_FORMAT
              valueFrom:
                configMapKeyRef:
                  name: newsinsight-config
                  key: LOG_FORMAT
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          volumeMounts:
            - name: dshm
              mountPath: /dev/shm
          livenessProbe:
            tcpSocket:
              port: 9090
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            tcpSocket:
              port: 9090
            initialDelaySeconds: 15
            periodSeconds: 10
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 2Gi
---
apiVersion: v1
kind: Service
metadata:
  name: autonomous-crawler
  namespace: newsinsight
spec:
  selector:
    app: autonomous-crawler
  ports:
    - port: 9090
      targetPort: 9090
      name: metrics
  type: ClusterIP
